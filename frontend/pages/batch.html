<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acasalamento em Lote - Genefy</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .btn-icon {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-subtle);
            color: var(--primary);
        }

        .female-result-card tbody tr:hover {
            background: var(--bg-subtle);
        }

        .female-result-card tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .female-result-card tbody tr:last-child td {
            border-bottom: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media print {
            .batch-summary,
            .btn,
            button {
                break-inside: avoid;
            }

            .female-result-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand" onclick="window.location='/dashboard'">
                <div class="brand-icon-box">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/cow.png" alt="Cow"
                        style="width: 24px; height: 24px;">
                </div>
                <span class="brand-text">Genefy<span>.</span></span>
            </div>
            <ul class="nav-menu">
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/herd">Rebanho</a></li>
                <li><a href="/manual">Manual</a></li>
                <li><a href="/batch" class="active">Lote</a></li>
                <li><a href="/history">Hist√≥rico</a></li>
                <li><a href="/analytics">An√°lises</a></li>
                <li><a href="/import">Dados</a></li>
                <li><a href="#" onclick="logout(event)" style="color: #dc2626;">Sair</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <header class="page-header">
            <div>
                <h1>Acasalamento em Lote</h1>
                <p>:: Otimiza√ß√£o para M√∫ltiplas F√™meas</p>
            </div>
        </header>

        <section class="section">
            <h2>1. Selecionar F√™meas</h2>
            <div class="form-group">
                <input type="text" id="search" class="form-control" placeholder="Buscar f√™meas...">
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>MILK</th>
                        </tr>
                    </thead>
                    <tbody id="females-table">
                        <tr>
                            <td colspan="4" class="loading">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination-controls"></div>
            <p id="selected-count" style="margin-top: 1rem;">0 f√™meas selecionadas</p>
        </section>

        <section class="section">
            <h2>2. Configura√ß√µes</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Top N Touros por F√™mea</label>
                    <input type="number" id="top-n" class="form-control" value="5" min="1" max="10">
                </div>
                <div class="form-group">
                    <label class="form-label">Consanguinidade M√°xima (%)</label>
                    <input type="number" id="max-inb" class="form-control" value="6.0" min="0" max="10" step="0.1">
                </div>
            </div>
            <button id="analyze-btn" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 1rem;" disabled>
                <i class="ph ph-rocket-launch" style="font-size: 1rem; font-weight: bold;"></i>
                Analisar Lote
            </button>
        </section>

        <div id="results-section" style="display: none;">
            <section class="section">
                <h2>Resultados</h2>
                <div id="results-container"></div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>Sistema de Acasalamento - Gado Leiteiro &copy; 2025</p>
    </footer>

    <script src="/js/api.js"></script>
    <script src="/js/logout.js"></script>
    <script>
        let selectedFemales = new Set();
        let allFemales = [];
        let currentPage = 1;
        let totalPages = 1;

        async function loadFemales(page = 1) {
            try {
                const search = document.getElementById('search').value;
                const data = await API.getFemales({
                    per_page: 50,
                    page: page,
                    search: search,
                    active_only: true
                });

                allFemales = data.females;
                currentPage = page;
                totalPages = data.total_pages || 1;

                renderFemales(allFemales);
                renderPagination();
            } catch (error) {
                document.getElementById('females-table').innerHTML =
                    '<tr><td colspan="4" class="empty-state">Erro ao carregar f√™meas</td></tr>';
            }
        }

        function renderFemales(females) {
            const tbody = document.getElementById('females-table');

            if (females.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Nenhuma f√™mea encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = females.map(f => `
                <tr>
                    <td><input type="checkbox" class="female-checkbox" name="female_select" value="${f.id}" ${selectedFemales.has(f.id) ? 'checked' : ''}></td>
                    <td>${f.reg_id || f.internal_id}</td>
                    <td>${f.name || '-'}</td>
                    <td>${f.milk || '-'}</td>
                </tr>
            `).join('');

            document.querySelectorAll('.female-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelected);
            });
        }

        function renderPagination() {
            const container = document.getElementById('pagination-controls');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-top: 1rem;">';

            if (currentPage > 1) {
                html += `<button class="btn btn-secondary" onclick="changePage(${currentPage - 1})">‚Üê Anterior</button>`;
            }

            html += `<span style="padding: 0 1rem;">P√°gina ${currentPage} de ${totalPages}</span>`;

            if (currentPage < totalPages) {
                html += `<button class="btn btn-secondary" onclick="changePage(${currentPage + 1})">Pr√≥xima ‚Üí</button>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadFemales(page);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateSelected() {
            document.querySelectorAll('.female-checkbox:checked').forEach(cb => {
                selectedFemales.add(parseInt(cb.value));
            });

            document.querySelectorAll('.female-checkbox:not(:checked)').forEach(cb => {
                selectedFemales.delete(parseInt(cb.value));
            });

            document.getElementById('selected-count').textContent =
                `${selectedFemales.size} f√™meas selecionadas`;
            document.getElementById('analyze-btn').disabled = selectedFemales.size === 0;
        }

        document.getElementById('select-all').addEventListener('change', (e) => {
            document.querySelectorAll('.female-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateSelected();
        });

        // Busca com delay
        let searchTimeout;
        document.getElementById('search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadFemales(1);
            }, 500);
        });

        // Configura√ß√µes do lote
        const BATCH_CONFIG = {
            topN: 3,
            maxInbreeding: 8.0,
            maxFemalesPerBatch: 100,
        };

        document.getElementById('analyze-btn').addEventListener('click', processBatch);

        async function processBatch() {
            const topNInput = document.getElementById('top-n');
            const maxInbInput = document.getElementById('max-inb');
            if (topNInput) BATCH_CONFIG.topN = parseInt(topNInput.value);
            if (maxInbInput) BATCH_CONFIG.maxInbreeding = parseFloat(maxInbInput.value);

            const selectedFemalesList = getSelectedFemales();
            
            if (selectedFemalesList.length === 0) {
                showToast('Selecione pelo menos uma f√™mea', 'warning');
                return;
            }
            
            if (selectedFemalesList.length > BATCH_CONFIG.maxFemalesPerBatch) {
                showToast(`M√°ximo de ${BATCH_CONFIG.maxFemalesPerBatch} f√™meas por lote`, 'warning');
                return;
            }
            
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">
                        Processando ${selectedFemalesList.length} f√™meas contra todos os touros dispon√≠veis...
                    </p>
                    <p style="font-size: 0.85rem; color: var(--text-tertiary);">
                        Isso pode levar alguns segundos
                    </p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/matings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        female_ids: selectedFemalesList,
                        top_n: BATCH_CONFIG.topN,
                        max_inbreeding: BATCH_CONFIG.maxInbreeding,
                        save: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayBatchResults(result);
                
            } catch (error) {
                console.error('Erro ao processar lote:', error);
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger);">
                        <i class="ph ph-warning-circle" style="font-size: 3rem;"></i>
                        <p style="margin-top: 1rem;">Erro ao processar lote</p>
                        <p style="font-size: 0.85rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        function displayBatchResults(result) {
            const container = document.getElementById('results-container');
            
            const summary = result.summary || {};
            const totalFemales = summary.total_females || result.results?.length || 0;
            const totalBulls = summary.total_bulls_analyzed || 0;
            const avgIEP = summary.average_iep || calculateAvgIEP(result.results);
            const avgInbreeding = summary.average_inbreeding || calculateAvgInbreeding(result.results);
            const uniqueBulls = summary.unique_bulls_recommended || countUniqueBulls(result.results);
            
            let html = `
                <div class="batch-summary" style="
                    background: linear-gradient(135deg, var(--primary-bg), var(--bg-subtle));
                    padding: 1.5rem;
                    border-radius: var(--radius);
                    margin-bottom: 2rem;
                    border: 1px solid var(--border);
                ">
                    <h3 style="font-family: var(--font-serif); margin-bottom: 1rem; color: var(--text-main);">
                        Resumo do Lote
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary);">${totalFemales}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">F√™meas</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--success);">${avgIEP.toFixed(1)}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">IEP M√©dio</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: ${avgInbreeding > 6.25 ? 'var(--warning)' : 'var(--success)'};">${avgInbreeding.toFixed(1)}%</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Consang. M√©dia</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius);">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--info);">${uniqueBulls}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Touros Usados</div>
                        </div>
                    </div>
                </div>
            `;
            
            html += `<div class="batch-results">`;
            
            for (const femaleResult of (result.results || [])) {
                html += createFemaleResultCard(femaleResult);
            }
            
            html += `</div>`;
            
            html += `
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportBatchToExcel()">
                        <i class="ph ph-file-xls"></i> Exportar Excel
                    </button>
                    <button class="btn btn-secondary" onclick="printBatchResults()">
                        <i class="ph ph-printer"></i> Imprimir
                    </button>
                    <button class="btn btn-success" onclick="saveBatchToHistory()">
                        <i class="ph ph-floppy-disk"></i> Salvar no Hist√≥rico
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function createFemaleResultCard(femaleResult) {
            const female = femaleResult.female || {};
            const topBulls = femaleResult.top_bulls || [];
            
            const femaleId = female.internal_id || female.reg_id || female.id;
            const femaleName = female.name || '';
            
            let bullsRows = '';
            
            for (const bull of topBulls) {
                const rank = bull.rank || 0;
                const bullInfo = bull.bull || {};
                const score = bull.score || bull.iep || 0;
                const grade = bull.grade || getGradeFromScore(score);
                const inbreeding = bull.inbreeding?.expected_inbreeding || bull.inbreeding || 0;
                const reliability = bull.reliability || 60;
                
                const scoreColor = score >= 70 ? 'success' : score >= 55 ? 'primary' : 'warning';
                const inbColor = inbreeding < 6.25 ? 'success' : inbreeding < 8 ? 'warning' : 'danger';
                const rankIcon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}¬∫`;
                
                bullsRows += `
                    <tr>
                        <td style="font-size: 1.2rem; text-align: center;">${rankIcon}</td>
                        <td>
                            <strong style="color: var(--text-main);">${bullInfo.code || 'N/A'}</strong>
                            ${bullInfo.name ? `<br><span style="font-size: 0.8rem; color: var(--text-secondary);">${bullInfo.name}</span>` : ''}
                        </td>
                        <td style="text-align: center;">
                            <span style="
                                background: var(--${scoreColor}-bg);
                                color: var(--${scoreColor});
                                padding: 4px 10px;
                                border-radius: 9999px;
                                font-weight: 600;
                                font-family: var(--font-mono);
                            ">${score.toFixed(1)}</span>
                        </td>
                        <td style="text-align: center; font-size: 0.85rem;">${grade}</td>
                        <td style="text-align: center;">
                            <span style="
                                background: var(--${inbColor}-bg);
                                color: var(--${inbColor});
                                padding: 4px 8px;
                                border-radius: var(--radius);
                                font-size: 0.85rem;
                            ">${inbreeding.toFixed(2)}%</span>
                        </td>
                        <td style="text-align: center; font-size: 0.85rem; color: var(--text-secondary);">
                            ${reliability.toFixed(0)}%
                        </td>
                        <td style="text-align: center;">
                            <button class="btn-icon" onclick="showBullDetails('${female.id}', '${bullInfo.id}')" title="Ver detalhes">
                                <i class="ph ph-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            if (topBulls.length === 0) {
                bullsRows = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="ph ph-warning" style="font-size: 1.5rem;"></i>
                            <p>Nenhum touro encontrado dentro dos crit√©rios</p>
                        </td>
                    </tr>
                `;
            }
            
            return `
                <div class="female-result-card" style="
                    background: white;
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    margin-bottom: 1.5rem;
                    overflow: hidden;
                ">
                    <div style="
                        background: var(--bg-subtle);
                        padding: 1rem 1.25rem;
                        border-bottom: 1px solid var(--border);
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üêÑ</span>
                            <div>
                                <strong style="font-size: 1.1rem; color: var(--text-main);">${femaleId}</strong>
                                ${femaleName ? `<span style="color: var(--text-secondary); margin-left: 0.5rem;">- ${femaleName}</span>` : ''}
                            </div>
                        </div>
                        <span style="
                            background: var(--primary-bg);
                            color: var(--primary);
                            padding: 4px 12px;
                            border-radius: 9999px;
                            font-size: 0.8rem;
                            font-weight: 500;
                        ">Top ${topBulls.length} touros</span>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-subtle);">
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary); width: 50px;">Rank</th>
                                    <th style="padding: 0.75rem; text-align: left; font-size: 0.85rem; color: var(--text-secondary);">Touro</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">IEP</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">Grade</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">Consang.</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary);">Conf.</th>
                                    <th style="padding: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--text-secondary); width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bullsRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getSelectedFemales() {
            const checkboxes = document.querySelectorAll('input[name="female_select"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        function getGradeFromScore(score) {
            if (score >= 85) return 'A+';
            if (score >= 75) return 'A';
            if (score >= 65) return 'B+';
            if (score >= 55) return 'B';
            if (score >= 45) return 'C';
            return 'D';
        }

        function calculateAvgIEP(results) {
            if (!results || results.length === 0) return 0;
            let total = 0;
            let count = 0;
            for (const r of results) {
                if (r.top_bulls && r.top_bulls.length > 0) {
                    total += r.top_bulls[0].score || r.top_bulls[0].iep || 0;
                    count++;
                }
            }
            return count > 0 ? total / count : 0;
        }

        function calculateAvgInbreeding(results) {
            if (!results || results.length === 0) return 0;
            let total = 0;
            let count = 0;
            for (const r of results) {
                if (r.top_bulls && r.top_bulls.length > 0) {
                    const inb = r.top_bulls[0].inbreeding?.expected_inbreeding || r.top_bulls[0].inbreeding || 0;
                    total += inb;
                    count++;
                }
            }
            return count > 0 ? total / count : 0;
        }

        function countUniqueBulls(results) {
            const bulls = new Set();
            for (const r of (results || [])) {
                for (const b of (r.top_bulls || [])) {
                    if (b.bull?.code) {
                        bulls.add(b.bull.code);
                    }
                }
            }
            return bulls.size;
        }

        function showBullDetails(femaleId, bullId) {
            window.open(`/manual?female=${femaleId}&bull=${bullId}`, '_blank');
        }

        function showToast(message, type = 'info') {
            alert(message);
        }

        async function exportBatchToExcel() {
            showToast('Gerando Excel...', 'info');
        }

        function printBatchResults() {
            window.print();
        }

        async function saveBatchToHistory() {
            showToast('Salvando no hist√≥rico...', 'info');
        }

        // Carregar primeira p√°gina
        loadFemales(1);
    </script>
</body>

</html>